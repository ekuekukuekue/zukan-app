<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>みんなの図鑑</title>
  <link rel="stylesheet" href="style.css" />
  <script src="script.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
</head>
<body>
  <header>
    <h1>みんなの図鑑</h1>
  </header>
  <div id="sharedListContainer"></div>
  <button onclick="location.href='index.html'">スタート画面に戻る</button>

  <script>
    const owner = 'ekuekukuekue';
    const repo = 'zukan-app';

    document.addEventListener("DOMContentLoaded", async () => {
      const sharedListContainer = document.getElementById('sharedListContainer');
      const token = Cookies.get('github_token');

      try {
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/shared-zukans`);
        if (!response.ok) {
          throw new Error('共有された図鑑が見つかりません。');
        }
        
        const fileList = await response.json();
        if (fileList.length === 0) {
          sharedListContainer.innerHTML = '<p>まだ共有された図鑑はありません。</p>';
          return;
        }

        const sharedZukans = await Promise.all(fileList.map(async file => {
          const zukanResponse = await fetch(`https://raw.githubusercontent.com/${owner}/${repo}/main/${file.path}`);
          const zukanData = await zukanResponse.json();
          // SHA情報を追加
          return { ...zukanData, sha: file.sha };
        }));

        sharedZukans.forEach(zukan => {
          const div = document.createElement('div');
          div.className = 'list-item';
          div.innerHTML = `
            <span>${zukan.name}</span>
            <div>
              <button onclick="localStorage.setItem('currentZukanId', '${zukan.id}'); localStorage.setItem('currentZukanSha', '${zukan.sha}'); location.href = 'zukan_view.html';">見る</button>
              <button onclick="if(confirm('「${zukan.name}」を削除しますか？')) { deleteSharedZukan('${zukan.id}', '${zukan.sha}', '${token}'); }">削除</button>
            </div>
          `;
          sharedListContainer.appendChild(div);
        });

      } catch (error) {
        sharedListContainer.innerHTML = `<p style="color:red;">エラー: ${error.message}</p>`;
      }
    });

    // 共有された図鑑を削除する関数
    async function deleteSharedZukan(zukanId, sha, token) {
      if (!token) {
        alert('トークンが保存されていません。共有ページでトークンを入力してください。');
        return;
      }
      
      const path = `shared-zukans/${zukanId}.json`;
      const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;

      try {
        const response = await fetch(apiUrl, {
          method: 'DELETE',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Delete shared zukan: ${zukanId}`,
            sha: sha
          })
        });

        if (!response.ok) {
          throw new Error('削除に失敗しました。トークンや権限を確認してください。');
        }

        alert('図鑑が正常に削除されました。');
        location.reload(); // ページを再読み込みしてリストを更新

      } catch (error) {
        alert(`削除に失敗しました。: ${error.message}`);
        console.error(error);
      }
    }
  </script>
</body>
</html>
